<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¤ Voxtral-Orpheus Voice Assistant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #48bb78;
            --error: #f56565;
            --warning: #ed8936;
            --bg: #f7fafc;
            --card: white;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: var(--card);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .header p {
            color: var(--text-light);
            margin: 0;
        }
        
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin: 16px 0;
            transition: all 0.3s ease;
        }
        
        .status.connecting { background: #fef5e7; color: var(--warning); }
        .status.connected { background: #f0fff4; color: var(--success); }
        .status.processing { background: #e6fffa; color: #319795; }
        .status.error { background: #fed7d7; color: var(--error); }
        
        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            margin: 24px 0;
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .record-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .record-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .record-btn.recording {
            background: var(--error);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(245, 101, 101, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0); }
        }
        
        .voice-select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }
        
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            background: #fafafa;
        }
        
        .chat-message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: white;
            color: var(--text);
            margin-right: auto;
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.system {
            background: #f7fafc;
            color: var(--text-light);
            font-style: italic;
            text-align: center;
            margin: 8px auto;
            max-width: 100%;
        }
        
        .audio-player {
            width: 100%;
            margin: 16px 0;
            border-radius: 8px;
        }
        
        .metrics {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¤ Voice Assistant</h1>
            <p>Powered by Voxtral & Orpheus TTS</p>
        </div>
        
        <div id="status" class="status connecting">Connecting to server...</div>
        
        <div class="controls">
            <button id="recordBtn" class="record-btn" disabled>ðŸŽ¤</button>
            <select id="voiceSelect" class="voice-select">
                <option value="tara">Tara (Default)</option>
                <option value="leah">Leah</option>
                <option value="jess">Jess</option>
                <option value="leo">Leo</option>
                <option value="dan">Dan</option>
                <option value="mia">Mia</option>
                <option value="zac">Zac</option>
                <option value="zoe">Zoe</option>
            </select>
        </div>
        
        <div id="chatContainer" class="chat-container"></div>
        
        <audio id="audioPlayer" class="audio-player" controls></audio>
        
        <div class="metrics">
            <span id="connectionStatus">Disconnected</span>
            <span id="processingTime">Processing: --ms</span>
        </div>
    </div>

    <script>
        // Global variables
        let ws;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let isProcessing = false;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const voiceSelect = document.getElementById('voiceSelect');
        const chatContainer = document.getElementById('chatContainer');
        const audioPlayer = document.getElementById('audioPlayer');
        const connectionStatus = document.getElementById('connectionStatus');
        const processingTime = document.getElementById('processingTime');
        
        // Status management
        function setStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addMessage(text, sender, metadata = null) {
            const msgEl = document.createElement('div');
            msgEl.className = `chat-message ${sender}`;
            
            if (metadata) {
                msgEl.innerHTML = `${text}<br><small style="opacity:0.7">${metadata}</small>`;
            } else {
                msgEl.textContent = text;
            }
            
            chatContainer.appendChild(msgEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // WebSocket connection
        function connect() {
            const sessionId = 'session_' + Math.random().toString(36).substring(2, 15);
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}`;
            
            setStatus('Connecting...', 'connecting');
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                setStatus('Connected! Click mic to speak', 'connected');
                connectionStatus.textContent = 'Connected';
                requestMicrophoneAccess();
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };
            
            ws.onclose = () => {
                setStatus('Connection lost. Reconnecting...', 'error');
                connectionStatus.textContent = 'Reconnecting...';
                recordBtn.disabled = true;
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                setStatus('Connection error', 'error');
            };
        }
        
        // Microphone access
        async function requestMicrophoneAccess() {
            try {
                // Request 16kHz audio to match Voxtral requirements
                const constraints = {
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set up MediaRecorder
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                    ? 'audio/webm;codecs=opus' 
                    : 'audio/webm';
                
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    if (audioChunks.length === 0) {
                        addMessage('No audio recorded', 'system');
                        return;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const reader = new FileReader();
                    
                    reader.onload = () => {
                        const base64Audio = reader.result.split(',')[1];
                        sendAudioMessage(base64Audio);
                    };
                    
                    reader.readAsDataURL(audioBlob);
                    audioChunks = [];
                };
                
                recordBtn.disabled = false;
                
            } catch (error) {
                console.error('Microphone access error:', error);
                setStatus('Microphone access denied', 'error');
                addMessage('Microphone access required for voice input', 'system');
            }
        }
        
        // Send audio message
        function sendAudioMessage(base64Audio) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('Connection not ready', 'system');
                return;
            }
            
            setStatus('Processing your request...', 'processing');
            isProcessing = true;
            recordBtn.disabled = true;
            
            const message = {
                type: 'audio',
                audio: base64Audio,
                voice: voiceSelect.value
            };
            
            ws.send(JSON.stringify(message));
            addMessage('ðŸŽ¤ Voice message sent', 'user');
        }
        
        // Handle server messages
        function handleServerMessage(data) {
            switch (data.type) {
                case 'audio_response':
                    setStatus('Response received! Click mic to speak again', 'connected');
                    
                    const processingTimeMs = Math.round(data.processing_time * 1000);
                    processingTime.textContent = `Processing: ${processingTimeMs}ms`;
                    
                    addMessage(
                        data.text, 
                        'assistant', 
                        `Generated in ${processingTimeMs}ms with ${data.voice || voiceSelect.value}`
                    );
                    
                    // Play the audio response
                    const audioSrc = `data:audio/wav;base64,${data.audio}`;
                    audioPlayer.src = audioSrc;
                    audioPlayer.play().catch(e => console.warn('Audio play failed:', e));
                    
                    isProcessing = false;
                    recordBtn.disabled = false;
                    break;
                    
                case 'error':
                    setStatus(`Error: ${data.message}`, 'error');
                    addMessage(`âŒ ${data.message}`, 'system');
                    isProcessing = false;
                    recordBtn.disabled = false;
                    break;
            }
        }
        
        // Recording controls
        function toggleRecording() {
            if (isProcessing) {
                return; // Don't allow recording while processing
            }
            
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'ðŸŽ¤';
                setStatus('Processing audio...', 'processing');
            } else {
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'â¹ï¸';
                setStatus('Recording... Click to stop', 'processing');
            }
        }
        
        // Event listeners
        recordBtn.addEventListener('click', toggleRecording);
        
        // Initialize connection
        connect();
        
        // Add welcome message
        setTimeout(() => {
            addMessage('Welcome! Click the microphone to start speaking.', 'system');
        }, 1000);
    </script>
</body>
</html>
